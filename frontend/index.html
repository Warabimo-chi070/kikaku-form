<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>衣笠クラブ 企画書ジェネレーター</title>
  <link rel="stylesheet" href="./public/style.css" />
  <style>
    /* ===== Base (keep current margins/spacing feel) ===== */
    :root{
      --bg:#0f1115; --panel:#111827; --border:#1f2937; --muted:#94a3b8; --text:#eaeef7;
      --surface:#0b0f17; --btn:#1f2937; --primary:#2563eb;
    }
    html,body{height:100%}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      margin:0; background:var(--bg); color:var(--text);
    }

    /* ===== App Bar ===== */
    header{padding:16px 20px; background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:50; backdrop-filter: blur(6px);}
    header .brand{font-weight:700; font-size:18px; margin:0;}
    header .sub{opacity:.8; font-size:12px}

    /* ===== Layout (two panes; keep generous spacing) ===== */
    .layout{display:grid; grid-template-columns:minmax(640px,1fr) 420px; gap:0; min-height:calc(100vh - 60px);}
    .pane{overflow:auto;}
    .left{border-right:1px solid var(--border);}
    .right{position:relative;}
    .sticky{position:sticky; top:76px}

    /* ===== Form Sections (preserve section paddings) ===== */
    .section{padding:16px 20px; border-bottom:1px dashed var(--border); background:transparent;}
    .section h2{margin:0 0 8px; font-size:16px;}
    .small{font-size:12px;}

    /* Grids (keep current visual rhythm) */
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:12px;}

    /* Controls */
    label{font-size:12px; opacity:.9; display:block; margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="datetime-local"], textarea, select, input[type="time"]{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:var(--surface); color:var(--text);
    }
    textarea{min-height:88px}
    .hint{font-size:11px; opacity:.75; margin-top:4px}

    /* Preview Card on the right */
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; margin:16px;}
    .card-head{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border)}
    .card-body{padding:16px}
    .preview h2{margin:16px 0 6px; font-size:16px; border-bottom:1px solid var(--border); padding-bottom:6px}
    .kvs{display:grid; grid-template-columns:180px 1fr; gap:6px 12px; font-size:14px}
    .muted{opacity:.7}
    .badge{display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid #334155; font-size:11px; margin-right:4px}

    /* Footer Action Bar (sticky) */
    .actionbar{position:sticky; bottom:0; z-index:60; display:flex; justify-content:space-between; gap:12px; align-items:center;
      padding:10px 16px; border-top:1px solid var(--border); background:rgba(17,24,39,.9); backdrop-filter: blur(6px)}
    button{padding:10px 14px; border-radius:10px; border:1px solid #334155; background:var(--btn); color:var(--text); cursor:pointer}
    button.primary{background:var(--primary); border-color:var(--primary); color:#fff; font-weight:700}
    button.secondary{background:#1e293b}
    button.ghost{background:transparent}
    button.link{background:transparent; border:none; color:#93c5fd; text-decoration:underline}

    /* Mobile */
    @media (max-width:1100px){
      .layout{grid-template-columns:1fr}
      .right{order:-1}
      .card{margin:12px}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">衣笠クラブ 企画書ジェネレーター</div>
    <div class="sub">ライブプレビュー &amp; DOCX出力</div>
  </header>

  <main class="layout">
    <!-- Left: Form (content preserved) -->
    <section class="pane left">
      <form id="form">
        <!-- 基本情報 -->
        <div class="section">
          <h2>基本情報</h2>
          <div class="grid">
            <div>
              <label>事業名</label>
              <input name="title" type="text" placeholder="例：第一回京都清掃" />
              <div class="hint">＊対外にも伝わる活動名か</div>
            </div>
            <div>
              <label>実施クラブ</label>
              <input name="club" type="text" value="京都衣笠クラブ" />
            </div>
            <div>
              <label>実施部署（〇〇セクション）</label>
              <input name="dept" type="text" placeholder="例：環境保護セクション" />
            </div>
            <div>
              <label>活動カテゴリ</label>
              <select name="category">
                <option>活動</option>
                <option>会合</option>
                <option>会議</option>
                <option>研修</option>
                <option>オンラインイベント</option>
              </select>
              <div class="hint">この中から1つ選択</div>
            </div>
            <div>
              <label>活動分野</label>
              <select name="field">
                <option>国際協力</option>
                <option>環境保護</option>
                <option>地域活性化</option>
                <option>災害救援</option>
                <option>社会福祉</option>
                <option>子ども</option>
                <option>その他の活動</option>
              </select>
              <div class="hint">この中から1つ選択（1分野に絞る）</div>
            </div>

            <div>
              <label>日時</label>
              <div class="two">
                <select name="year" id="yearSel"></select>
                <select name="month" id="monthSel"></select>
                <select name="day" id="daySel"></select>
              </div>
              <div class="two" style="margin-top:8px">
                <input name="time_start" id="timeStart" type="time" value="09:00">
                <input name="time_end" id="timeEnd" type="time" value="17:00">
              </div>
              <div class="hint">曜日は自動計算。表示形式：2025年9月22日（月） 15:00-19:00</div>
            </div>

            <div>
              <label>活動場所（市町まで記入）</label>
              <input name="place" type="text" placeholder="例：京都府京都市北区 立命館大学周辺" />
            </div>

            <div class="two">
              <div>
                <label>想定人数（IVUSA）</label>
                <input name="expected_ivusa" type="number" min="0" value="0" />
              </div>
              <div>
                <label>想定人数（他）</label>
                <input name="expected_other" type="number" min="0" value="0" />
              </div>
            </div>

            <div>
              <label>事業責任者（氏名・所属大学）</label>
              <input name="owner" type="text" placeholder="" />
            </div>
            <div>
              <label>他クラブ参加</label>
              <select name="other_club">
                <option>可能</option>
                <option>不可能</option>
              </select>
            </div>
            <div>
              <label>受益者（活動で利益を受ける人）</label>
              <input name="beneficiary" type="text" placeholder="" />
            </div>
            <div>
              <label>新規事業かどうか</label>
              <select name="is_new">
                <option>既存（これまでにやったことがある活動）</option>
                <option>新規（これまでにやったことがない活動）</option>
              </select>
            </div>
            <div>
              <label>活動内容の種類</label>
              <select name="activity_kind">
                <option>屋外での作業</option>
                <option>活動・イベントの参加者との交流</option>
                <option>受益者への支援（サポート）</option>
                <option>ワークショップや勉強会</option>
                <option>社会への情報発信や提言</option>
              </select>
            </div>
            <div>
              <label>活動期間</label>
              <select name="duration">
                <option>3時間未満</option>
                <option>3時間以上1日未満</option>
                <option>1日以上2日未満</option>
                <option>2日以上5日未満</option>
                <option>5日以上2週間未満</option>
                <option>2週間以上</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 必要スキル -->
        <div class="section">
          <h2>必要スキル（優先度上位3つまで）</h2>
          <div class="grid">
            <div><label><input type="checkbox" name="skills" value="体力" /> 体力</label></div>
            <div><label><input type="checkbox" name="skills" value="社会課題の専門知識" /> 当該の社会的課題に関する専門的知識</label></div>
            <div><label><input type="checkbox" name="skills" value="モチベーション管理（スタマネ）" /> 隊員のモチベーション管理（スタマネ）</label></div>
            <div><label><input type="checkbox" name="skills" value="現地コミュニケーション能力" /> 現地の人とのコミュニケーション能力</label></div>
            <div><label><input type="checkbox" name="skills" value="渉外・営業スキル" /> 渉外・営業スキル（対企業・支援者）</label></div>
            <div><label><input type="checkbox" name="skills" value="ロジスティクス" /> ロジスティックス</label></div>
            <div><label><input type="checkbox" name="skills" value="Excelスキル" /> Excelスキル</label></div>
            <div><label><input type="checkbox" name="skills" value="文章作成" /> 文章作成（ライティング）</label></div>
            <div><label><input type="checkbox" name="skills" value="デザイン・動画編集" /> デザイン・動画編集などのスキル</label></div>
            <div><label><input type="checkbox" name="skills" value="サバイバル能力" /> ハードな環境におけるサバイバル能力</label></div>
            <div><label><input type="checkbox" name="skills" value="政策提案（アドボカシー）" /> 政策提案（アドボカシー）能力・経験</label></div>
            <div><label><input type="checkbox" name="skills" value="語学" /> 語学</label></div>
          </div>
          <div class="hint">優先順位の高いものから最大3つまで選択してください。</div>
        </div>

        <!-- 目的・達成要件 -->
        <div class="section">
          <h2>目的・達成要件</h2>
          <label>目的（背景・対外性・5W1Hを意識）</label>
          <textarea name="purpose" placeholder="背景にある社会問題、対外的要素、5W1H（誰が・何を・いつ・どこで・なぜ・どのように）を含めて記述"></textarea>
          <label>達成要件（確実に測れるもの、可能なら数値で）</label>
          <textarea name="kpi" placeholder="例：参加者アンケート満足度80%以上、回収した漂着ゴミ〇袋、SNS到達数〇件 等"></textarea>
        </div>

        <!-- 内容 -->
        <div class="section">
          <h2>内容（5W1H・作業内容・手順）</h2>
          <textarea name="details" placeholder="活動内容がわかるように。作業内容・手順、5W1Hの要素も含める"></textarea>
        </div>

        <!-- 事業計画 -->
        <div class="section">
          <h2>事業計画</h2>
          <label>事業実施までのスケジュール</label>
          <textarea name="pre_schedule" placeholder="
          承認のタイミング、下見の日程、打ち合わせの日程、周知のタイミングなど
          事後業務のスケジュールも忘れずに！！
          "></textarea>
          <label>計画実行のためのスケジュール</label>
          <textarea name="exec_schedule" placeholder="IVUSAとしてのゴールを明確に記述する"></textarea>
        </div>

        <!-- 当日計画 -->
        <div class="section">
          <h2>当日計画（作戦）</h2>
          <label>当日のタイムスケジュール</label>
          <textarea name="day_schedule" placeholder="
          活動当日のタイムスケジュール
          （集合時間、活動開始時間、終了時間、他団体の方との打ち合わせの時間、休憩時間など）
          "></textarea>
        </div>

        <!-- リスクチェック -->
        <div class="section">
          <h2>リスクチェック</h2>
          <label>事前のリスクヘッジ（発生要因／予防策／発生時対応）</label>
          <textarea name="risk_before" placeholder="
          準備段階で起こりうるリスクを書く
          （どんな些細なことでもよいので、できるだけたくさん書こう）
          →どうやったらそのリスクを防げるか書く
          ⇒リスクが起こってしまった場合の対応策を書く
          "></textarea>
          <label>当日のリスクヘッジ（発生要因／予防策／発生時対応）</label>
          <textarea name="risk_during" placeholder="
          当日起こりうるリスクを書く
          （どんな些細なことでもよいので、できるだけたくさん書いてみよう）
          →どうやったらそのリスクを防げるか書く
          ⇒リスクが起こってしまった場合の対応策を書く
          "></textarea>
        </div>

        <!-- 実施主体 -->
        <div class="section">
          <h2>実施主体</h2>
          <label>関係機関・カウンターパート等（IVUSAとの関係性／団体名／URL）</label>
          <textarea name="stakeholders" placeholder="
          IVUSAとの関係性
          どこの誰（団体）なのかまで詳しく書く！！
          (団体紹介のURLなんかも貼ってくれると助かります。)
          "></textarea>
        </div>

        <!-- その他 -->
        <div class="section">
          <h2>その他</h2>
          <div class="grid">
            <div>
              <label>役所への申請</label>
              <select name="permit_city">
                <option>許認可申請</option>
                <option>実施事前告知</option>
                <option>実施合意</option>
                <option>不要</option>
              </select>
            </div>
            <div>
              <label>消防署への申請</label>
              <select name="permit_fire">
                <option>許認可申請</option>
                <option>実施事前告知</option>
                <option>実施合意</option>
                <option>不要</option>
              </select>
            </div>
            <div>
              <label>警察への申請</label>
              <select name="permit_police">
                <option>許認可申請</option>
                <option>実施事前告知</option>
                <option>実施合意</option>
                <option>不要</option>
              </select>
            </div>
          </div>
          <label>その他（任意）</label>
          <textarea name="other_notes" placeholder=""></textarea>

          <h3 class="small">予算と資金調達方法</h3>
          <div class="grid">
            <div>
              <label>予算総額（円）</label>
              <input name="budget_total" type="number" min="0" value="0" />
            </div>
            <div>
              <label>調達方法</label>
              <select name="funding">
                <option>クラブ金</option>
                <option>参加費徴収</option>
                <option>本部事業基金</option>
                <option>その他</option>
              </select>
            </div>
          </div>
          <label>予算の使途（具体的に）</label>
          <textarea name="budget_usage" placeholder="何にいくら使うか具体的に明記"></textarea>

          <h3 class="small">広報</h3>
          <div class="grid">
            <div>
              <label>プレスリリース</label>
              <select name="press">
                <option>無し</option>
                <option>有り</option>
              </select>
            </div>
            <div></div>
          </div>

          <h3 class="small">安全・運用</h3>
          <div class="grid">
            <div><label>学生運転</label><select name="drive_student">
                <option>無し</option><option>有り</option></select></div>
            <div><label>レンタカー利用</label><select name="rentacar">
                <option>無し</option><option>有り</option></select></div>
            <div><label>一般参加</label><select name="general_join">
                <option>無し</option><option>有り</option></select></div>
            <div><label>刃物使用</label><select name="knife">
                <option>無し</option><option>有り</option></select></div>
            <div><label>動力機材使用</label><select name="power_tool">
                <option>無し</option><option>有り</option></select></div>
            <div><label>自炊</label><select name="self_cook">
                <option>無し</option><option>有り</option></select></div>
            <div><label>宿泊利用</label><select name="stay">
                <option>無し</option><option>有り</option></select></div>
          </div>
        </div>

        <!-- 緊急連絡先 -->
        <div class="section">
          <h2>緊急連絡先</h2>
          <div class="grid">
            <div>
              <label>クラマネ</label>
              <input name="emg_clubman" type="text" placeholder="例：中村斎人" />
            </div>
            <div>
              <label>担当役員</label>
              <input name="emg_officer" type="text" placeholder="例：名前（担当部署）" />
            </div>
            <div>
              <label>当日責任者</label>
              <input name="emg_day" type="text" placeholder="例：名前（セク長やリーダー）" />
            </div>
            <div>
              <label>緊急時の連絡体制は明確か？</label>
              <select name="emg_ok">
                <option>はい</option>
                <option>いいえ</option>
              </select>
            </div>
          </div>
        </div>
      </form>
    </section>

    <!-- Right: Preview -->
    <aside class="pane right">
      <div class="card sticky">
        <div class="card-head">
          <h2>プレビュー</h2>
          <small id="updatedAt">—</small>
        </div>
        <div class="card-body">
          <div id="preview"></div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Footer Actions (IDs preserved) -->
  <footer class="actionbar">
    <div class="left">
      <button type="button" id="saveLocal" class="ghost">一時保存（端末）</button>
      <button type="button" id="loadLocal" class="link">読込</button>
      <button type="button" id="clearLocal" class="link">クリア</button>
    </div>
    <div class="right">
      <button type="button" id="exportJSON" class="secondary">JSONダウンロード</button>
      <button type="button" class="primary" id="exportDOCX">DOCX出力</button>
    </div>
  </footer>

  <script>
    // ==== Keep existing logic; only tidied for single #preview ====
    const form = document.getElementById('form');
    const preview = document.getElementById('preview');
    const serverURL = 'http://127.0.0.1:5000'; // 既存どおり

    let rawTemplate = "";

    // 初期ロードでテンプレを取得
    fetch(serverURL + "/template")
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          rawTemplate = data.template_text || "";
          renderPreview({}); // 初期プレビュー
        } else {
          console.error("テンプレ取得失敗", data.error);
          preview.innerHTML = "テンプレ取得に失敗しました";
        }
      })
      .catch(err => {
        console.error("テンプレAPIエラー", err);
        preview.innerHTML = "テンプレ取得に失敗しました (通信エラー)";
      });

    function renderWithTokens(text, mapping) {
      return text.replace(/\{\{\s*([a-zA-Z0-9_]+)\s*(?:\|\|\s*(.+?))?\s*\}\}/g,
        (match, key, deflt) => {
          const val = mapping[key];
          if (val !== undefined && val !== null && val !== "") {
            return val;
          }
          return deflt || "";
        });
    }

    const WEEKDAY_JP = ['日','月','火','水','木','金','土'];
    function formatDateTimeFromParts(year, month, day, tStart, tEnd) {
      if (!year || !month || !day || !tStart || !tEnd) return '';
      try{
        const y=parseInt(year,10), m=parseInt(month,10), d=parseInt(day,10);
        const date=new Date(y, m-1, d);
        if (isNaN(date.getTime())) return '';
        const wd=WEEKDAY_JP[date.getDay()];
        const ts=tStart.slice(0,5), te=tEnd.slice(0,5);
        return `${y}年${m}月${d}日（${wd}） ${ts}-${te}`;
      }catch(e){return ''}
    }

    function populateDateSelects() {
      const yearSel=document.getElementById('yearSel');
      const monthSel=document.getElementById('monthSel');
      const daySel=document.getElementById('daySel');
      if(!yearSel||!monthSel||!daySel) return;
      const now=new Date();
      const currentYear=now.getFullYear();
      const years=[currentYear, currentYear+1, currentYear+2];
      years.forEach(y=>{ const o=document.createElement('option'); o.value=y; o.textContent=`${y}年`; yearSel.appendChild(o); });
      for(let m=1;m<=12;m++){ const o=document.createElement('option'); o.value=m; o.textContent=`${m}月`; monthSel.appendChild(o); }
      function rebuildDays(){
        const y=parseInt(yearSel.value,10)||currentYear;
        const m=parseInt(monthSel.value,10)||1;
        const lastDay=new Date(y,m,0).getDate();
        const prev=daySel.value; daySel.innerHTML='';
        for(let d=1; d<=lastDay; d++){ const o=document.createElement('option'); o.value=d; o.textContent=`${d}日`; daySel.appendChild(o); }
        if(prev && prev <= lastDay) daySel.value=prev;
      }
      yearSel.onchange=rebuildDays; monthSel.onchange=rebuildDays;
      yearSel.value=currentYear.toString(); monthSel.value=(now.getMonth()+1).toString();
      rebuildDays(); daySel.value=now.getDate().toString();
    }

    function formDataToObject(formEl){
      const data=new FormData(formEl);
      const obj={};
      for(const [k,v] of data.entries()){
        if(k==='skills'){ if(!obj[k]) obj[k]=[]; if(!obj[k].includes(v)) obj[k].push(v); }
        else { obj[k]=v; }
      }
      if(obj.skills && obj.skills.length>3) obj.skills = obj.skills.slice(0,3);
      obj.formatted_datetime = formatDateTimeFromParts(obj.year, obj.month, obj.day, obj.time_start, obj.time_end);
      return obj;
    }

    function renderPreview(obj){
      // DOCXテンプレを右側でプレビュー（未入力はテンプレのデフォルトが出る）
      if(!rawTemplate){
        preview.innerHTML = "テンプレがまだ読み込まれていません";
      }else{
        const html = renderWithTokens(rawTemplate, obj).replace(/\\n/g,"<br>").replace(/\\t/g,"&emsp;");
        preview.innerHTML = html;
      }
      document.getElementById('updatedAt').textContent = new Date().toLocaleString();
    }

    function update(){ renderPreview(formDataToObject(form)); }
    form.addEventListener('input', update);
    window.addEventListener('DOMContentLoaded', ()=>{
      populateDateSelects();
      // restore local
      const saved=localStorage.getItem('kikasu_proposal');
      if(saved){
        const obj=JSON.parse(saved);
        for(const [k,v] of Object.entries(obj)){
          const el=form.elements[k]; if(!el) continue;
          if(el.type==='select-one' || el.type==='text' || el.type==='number' || el.type==='textarea'){ el.value=v; }
        }
        const skills=obj.skills||[];
        [...form.querySelectorAll('input[name="skills"]')].forEach(cb=>{ cb.checked = skills.includes(cb.value); });
      }
      update();
    });

    // Actions
    document.getElementById('saveLocal').onclick = () => {
      const obj = formDataToObject(form);
      localStorage.setItem('kikasu_proposal', JSON.stringify(obj));
      alert('この端末に一時保存しました。');
    };
    document.getElementById('loadLocal').onclick = () => {
      const saved = localStorage.getItem('kikasu_proposal');
      if (!saved) return alert('保存データが見つかりません。');
      const obj = JSON.parse(saved);
      for (const [k, v] of Object.entries(obj)) {
        const el = form.elements[k];
        if (!el) continue;
        if (el.type === 'select-one' || el.type === 'text' || el.type === 'number' || el.type === 'textarea') {
          el.value = v;
        }
      }
      const skills = obj.skills || [];
      [...form.querySelectorAll('input[name="skills"]')].forEach(cb => cb.checked = skills.includes(cb.value));
      update();
      alert('保存データを読み込みました。');
    };
    document.getElementById('clearLocal').onclick = () => {
      if (!confirm('プレビューと入力をクリアします。よろしいですか？')) return;
      form.reset();
      localStorage.removeItem('kikasu_proposal');
      update();
    };
    document.getElementById('exportJSON').onclick = () => {
      const obj = formDataToObject(form);
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'proposal.json'; a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById('exportDOCX').onclick = async () => {
      const obj = formDataToObject(form);
      try{
        const res = await fetch(serverURL + '/generate', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(obj)
        });
        if(!res.ok) throw new Error('DOCX生成に失敗しました');
        const data = await res.json();
        if(data.download_url){
          const a = document.createElement('a'); a.href = serverURL + data.download_url; a.target = '_blank'; a.click();
        }else{
          alert('生成成功。出力先: ' + (data.output_path || ''));
        }
      }catch(e){
        alert('エラー: ' + e.message + '\\nサーバー（app.py）が起動しているか確認してください。');
      }
    };
  </script>
</body>
</html>